# Futures Pair Trading Backtester (期货配对交易回测系统)

![Status](https://img.shields.io/badge/Status-Active-green)
![Python](https://img.shields.io/badge/Python-3.9%2B-blue)

## 1. 项目简介

这是一个针对**期货市场**设计的配对交易（统计套利）回测工具。

很多网上的教程或 demo 代码在计算收益时，往往假设“信号出现的瞬间就能成交”，或者忽略了参数计算时的未来函数，导致回测曲线非常漂亮，但一上实盘就失效。

**本项目的核心目的只有两个：**
1.  **不说谎**：严格区分“观察期”和“执行期”，杜绝未来函数。
2.  **可复现**：代码结构清晰，确保每一次回测的逻辑与实盘执行逻辑一致。

---

## 2. 我做了什么

我们没有发明新的数学公式，只是把经典的 OLS 和 Kalman 滤波在**工程实现**上做对了。

### 真正防未来函数 (No Look-ahead Bias)
- **模型层**：在计算 Spread 时，强制使用**滞后一期 ($T-1$)** 的 Beta。
    - *原因*：你不能用今天的收盘价算出来的 Beta，去指导今天盘中的对冲，这是穿越。
- **执行层**：强制 **T+1 执行**。
    - *逻辑*：$T$ 日收盘产生信号 -> $T+1$ 日开盘/收盘成交。哪怕回测收益低一点，但这才是真的。

### 适配期货特性的风控
- **波动率倒数加权**：期货自带杠杆，不能全仓梭哈。我们引入了 `vol_target`，波动率越大，自动把仓位系数降下来。
- **协整失效保护**：内置了 Rolling ADF 检验，当价差不再均值回归（趋势化）时，自动停止开仓。
- **死扛保护**：不仅有止损，还有**最大持仓天数**限制，防止资金被长期占用。

### 稳健的数据处理
- **软失效 (Soft Invalid)**：数据源偶尔会有 NaN 或 Inf。普通脚本会直接报错或乱平仓，我们加入了 `Hold` 状态，数据异常时维持仓位，减少无谓的滑点磨损。

---

## 3. 项目结构

```text
src/
├── models.py       # 算数的：RollingOLS, KalmanFilter (计算 Beta, Z-Score)
├── signals.py      # 决策的：把 Z-Score 变成 -1/0/1，处理止损、冷却期
├── execution/      
│   └── sim_adapter.py  # 算钱的：模拟 T+1 成交，扣手续费，出净值
├── rules.py        # 调参的：所有阈值、窗口都在这里
└── main.py         # 启动脚本